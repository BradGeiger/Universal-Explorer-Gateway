import shutil
import os
from flask import jsonify

# --- Mitigation Configuration Slots ---
ARCHIVE_PATH = "{{ARCHIVE_DESTINATION}}"

@app.route('/mitigate', methods=['POST'])
def mitigate_conflict():
    data = request.json
    action = data.get('action') # 'merge' or 'archive'
    path_a = data.get('path_a')
    path_b = data.get('path_b')

    try:
        if action == 'archive':
            # Logic Slot: Archive Mitigation
            shutil.make_archive(os.path.join(ARCHIVE_PATH, os.path.basename(path_b)), 'zip', path_b)
            shutil.rmtree(path_b)
            message = f"Archived {path_b} successfully."

        elif action == 'merge':
            # Logic Slot: Merge Mitigation (Move files from B to A if not existing)
            for file in os.listdir(path_b):
                src = os.path.join(path_b, file)
                dst = os.path.join(path_a, file)
                if not os.path.exists(dst):
                    shutil.move(src, dst)
            shutil.rmtree(path_b)
            message = f"Merged {path_b} into {path_a}."

        return jsonify({"status": "success", "message": message})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500
